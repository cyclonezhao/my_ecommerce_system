# gRPC配合Etcd的原理

## 概述

需要实现2个用例：

1. 服务提供者实例往Etcd注册自身
2. 服务消费者通过Etcd找到服务提供者实例，连接服务提供者实例，并调用服务方法

## 服务实例注册

整体步骤：

1. 创建endPoint管理器。endPoint管理器包含“Etcd客户端”和“服务前缀”
2. 通过endPoint管理器，将自身作为endPoint加到Etcd中，并对应到一个名字
3. 自身加到Etcd后，还要定期向Etcd续约，以保持自己的在线状态

## 服务实例发现

1. 通过gRPC连接到etcd://<key前缀>，此时会拿到多个符合条件的value，也就是endPoint列表
2. 通过Etcd Resolver解析endPoint列表，得到一组服务提供者实例的地址
3. 通过LB选出其中一个服务提供者实例，与之建立连接，进行后续通信

# 服务调用

## 概述

1. 服务提供者将调用请求路由到业务处理器，并回发处理结果
2. 服务消费者通过网络连接，发送包含业务方法信息的网络数据，并处理返回结果

上述两点都需要通过Stub实现，Stub的代码通过ProtoBuf生成。

## 服务提供者接收，处理调用请求

1. 新建grpcServer
2. 将Stub注册到grpcServer
3. grpcServer监听tcp

## 服务调用者调用服务提供者

1. 将网络连接注册到Stub对象
2. 调用Stub对象的业务方法，由后者将调用序列化，并通过网络连接发往服务提供者实例